# CUCM Log Collector - Docker Compose Configuration
#
# Usage:
#   1. Copy .env.example to .env and configure your settings
#   2. Run: docker-compose up -d
#   3. Access API at http://localhost:8000
#   4. CUCM devices connect to SFTP at your-server:2222
#
# For production, update SFTP_HOST to your server's public IP/hostname

version: '3.8'

services:
  cucm-collector:
    build:
      context: .
      dockerfile: Dockerfile
    image: cucm-log-collector:latest
    container_name: cucm-log-collector
    restart: unless-stopped

    # Port mappings
    ports:
      - "8000:8000"   # FastAPI HTTP API
      - "2222:2222"   # Embedded SFTP Server

    # Environment variables
    environment:
      # API Settings
      - API_HOST=0.0.0.0
      - API_PORT=8000
      - LOG_LEVEL=${LOG_LEVEL:-INFO}

      # Authentication (optional - leave empty to disable)
      - API_KEY=${API_KEY:-}

      # CORS (adjust for your frontend domain in production)
      - CORS_ALLOWED_ORIGINS=${CORS_ALLOWED_ORIGINS:-^https?://(localhost|127\.0\.0\.1)(:\d+)?$}

      # SFTP Client Settings (what we tell CUCM to connect to)
      # IMPORTANT: Set SFTP_HOST to your Docker host's IP/hostname
      # This is the address CUCM will use to push files back
      - SFTP_HOST=${SFTP_HOST:?SFTP_HOST is required - set to your server IP}
      - SFTP_PORT=${SFTP_PORT:-2222}
      - SFTP_USERNAME=${SFTP_USERNAME:-cucm-collector}
      - SFTP_PASSWORD=${SFTP_PASSWORD:?SFTP_PASSWORD is required}
      - SFTP_REMOTE_BASE_DIR=${SFTP_REMOTE_BASE_DIR:-}

      # Embedded SFTP Server Settings (runs inside container)
      - SFTP_SERVER_ENABLED=true
      - SFTP_SERVER_HOST=0.0.0.0
      - SFTP_SERVER_PORT=2222

      # Storage Settings
      - STORAGE_ROOT=/app/storage

      # Job Settings
      - MAX_CONCURRENCY_PER_JOB=${MAX_CONCURRENCY_PER_JOB:-2}
      - JOB_COMMAND_TIMEOUT_SEC=${JOB_COMMAND_TIMEOUT_SEC:-600}
      - JOB_CONNECT_TIMEOUT_SEC=${JOB_CONNECT_TIMEOUT_SEC:-30}

      # Security Settings
      - MAX_SSH_RETRIES=${MAX_SSH_RETRIES:-3}
      - MAX_SFTP_RETRIES=${MAX_SFTP_RETRIES:-3}

      # Retention
      - RETENTION_DAYS=${RETENTION_DAYS:-7}
      - CLEANUP_ENABLED=${CLEANUP_ENABLED:-true}

    # Volume mounts
    volumes:
      # Persistent storage for jobs, transcripts, and received files
      - ./storage:/app/storage

      # Optional: Mount custom profiles
      # - ./profiles.yaml:/app/profiles.yaml:ro

    # Resource limits (adjust based on your needs)
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 256M

    # Health check
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8000/health')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

    # Logging configuration
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

# Optional: Add a reverse proxy for HTTPS
# Uncomment and configure if needed
#
#   nginx:
#     image: nginx:alpine
#     container_name: cucm-collector-proxy
#     restart: unless-stopped
#     ports:
#       - "443:443"
#       - "80:80"
#     volumes:
#       - ./nginx.conf:/etc/nginx/nginx.conf:ro
#       - ./certs:/etc/nginx/certs:ro
#     depends_on:
#       - cucm-collector

# Named volumes (alternative to bind mounts)
# Uncomment if you prefer named volumes
#
# volumes:
#   storage:
#     driver: local
