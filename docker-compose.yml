services:
  app:
    build:
      context: .
      dockerfile: Dockerfile
    image: cucm-log-collector:latest
    container_name: cucm-log-collector
    ports:
      # Main application port (Frontend UI + API)
      - "8000:8000"
      # SFTP server port (for CUCM to upload files in local mode)
      - "2222:2222"
    volumes:
      # Persist storage across container restarts
      - ./storage:/app/storage
      # Optional: Mount profiles.yaml for customization
      - ./Backend/profiles.yaml:/app/profiles.yaml:ro
    env_file:
      - .env
    environment:
      # ======================================
      # Application Settings (fixed)
      # ======================================
      - ARTIFACTS_DIR=/app/storage/received
      - JOBS_DIR=/app/storage/jobs
      - TRANSCRIPT_DIR=/app/storage/transcripts

      # ======================================
      # SFTP Mode (from .env file)
      # ======================================
      # Switch modes:  cp .env.relay .env   (VPN/relay)
      #                cp .env.local .env   (direct/embedded)
      - SFTP_RELAY_MODE=${SFTP_RELAY_MODE:-false}
      - SFTP_HOST=${SFTP_HOST:-}
      - SFTP_PORT=${SFTP_PORT:-2222}
      - SFTP_USERNAME=${SFTP_USERNAME:-cucm-collector}
      - SFTP_PASSWORD=${SFTP_PASSWORD:-cucm-collector}
      - SFTP_REMOTE_BASE_DIR=${SFTP_REMOTE_BASE_DIR:-}

      # ======================================
      # Embedded SFTP Server (from .env file)
      # ======================================
      - SFTP_SERVER_ENABLED=${SFTP_SERVER_ENABLED:-true}
      - SFTP_SERVER_HOST=${SFTP_SERVER_HOST:-0.0.0.0}
      - SFTP_SERVER_PORT=${SFTP_SERVER_PORT:-2222}
      - SFTP_ROOT_PATH=/app/storage/received

      # ======================================
      # Security Settings
      # ======================================
      # Uncomment to enable API key authentication
      # - API_KEY=your-secret-api-key-here
      - CORS_ALLOWED_ORIGINS=${CORS_ALLOWED_ORIGINS:-.*}

      # ======================================
      # Logging
      # ======================================
      - LOG_LEVEL=${LOG_LEVEL:-INFO}

    restart: unless-stopped

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

    # Resource limits (optional - adjust based on your needs)
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 512M
