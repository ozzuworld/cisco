# CUCM Log Collector - Docker Compose Configuration
#
# Usage:
#   1. Copy .env.example to .env and set SFTP_PASSWORD
#   2. Run: docker-compose up -d
#   3. Access API at http://localhost:8000
#   4. CUCM devices connect to SFTP at your-server:2222
#
# SFTP_HOST is auto-detected! The app will automatically detect the host's IP.
# Override with SFTP_HOST env var if auto-detection doesn't work for your network.
#
# ============================================================================
# VPN SCENARIO CONFIGURATION
# ============================================================================
# If you're connecting to CUCM over VPN, use ONE of these options:
#
# OPTION 1 (Recommended): Use host networking mode
#   Uncomment network_mode and comment out the ports section below.
#   This allows the container to use your VPN interface directly.
#
# OPTION 2: Set SFTP_HOST to your VPN IP manually
#   In your .env file: SFTP_HOST=10.x.x.x (your VPN IP)
#   Keep the ports section as-is.
#
# To find your VPN IP on Windows: ipconfig | findstr "10."
# To find your VPN IP on Linux/Mac: ip addr | grep "10\."
# ============================================================================

version: '3.8'

services:
  cucm-collector:
    build:
      context: .
      dockerfile: Dockerfile
    image: cucm-log-collector:latest
    container_name: cucm-log-collector
    restart: unless-stopped

    # VPN OPTION 1: Uncomment this line to use host networking (recommended for VPN)
    # network_mode: host

    # Port mappings (comment out if using network_mode: host)
    ports:
      - "8000:8000"   # FastAPI HTTP API
      - "2222:2222"   # Embedded SFTP Server

    # Environment variables
    environment:
      # API Settings
      - API_HOST=0.0.0.0
      - API_PORT=8000
      - LOG_LEVEL=${LOG_LEVEL:-INFO}

      # Authentication (optional - leave empty to disable)
      - API_KEY=${API_KEY:-}

      # CORS - allows all origins by default for ease of deployment
      # Override with specific domain regex for production if needed
      - CORS_ALLOWED_ORIGINS=${CORS_ALLOWED_ORIGINS:-.*}

      # ================================================================
      # SFTP Settings (where CUCM pushes files via "file get activelog")
      # ================================================================
      # CUCM does NOT support inbound SFTP or SCP - it can only PUSH
      # files outbound to an external SFTP server.
      #
      # DOCKER DESKTOP (Windows/Mac):
      #   Docker Desktop port forwarding breaks SSH key exchange, so
      #   CUCM cannot reach the container's embedded SFTP server.
      #   Point these at your HOST machine's SSH/SFTP server instead:
      #     SFTP_HOST=<your PC's IP>  (e.g., 192.168.1.100)
      #     SFTP_PORT=22
      #     SFTP_USERNAME=<your PC login>
      #     SFTP_PASSWORD=<your PC password>
      #     SFTP_REMOTE_BASE_DIR=<absolute path to storage/received>
      #
      # NATIVE LINUX DOCKER:
      #   The embedded SFTP server on port 2222 works directly.
      #   Leave defaults as-is.
      # ================================================================
      - SFTP_HOST=${SFTP_HOST:-}
      - SFTP_PORT=${SFTP_PORT:-2222}
      - SFTP_USERNAME=${SFTP_USERNAME:-cucm-collector}
      - SFTP_PASSWORD=${SFTP_PASSWORD:?SFTP_PASSWORD is required}
      - SFTP_REMOTE_BASE_DIR=${SFTP_REMOTE_BASE_DIR:-}

      # Embedded SFTP Server Settings (runs inside container)
      - SFTP_SERVER_ENABLED=true
      - SFTP_SERVER_HOST=0.0.0.0
      - SFTP_SERVER_PORT=2222

      # Storage Settings
      - STORAGE_ROOT=/app/storage

      # Job Settings
      - MAX_CONCURRENCY_PER_JOB=${MAX_CONCURRENCY_PER_JOB:-2}
      - JOB_COMMAND_TIMEOUT_SEC=${JOB_COMMAND_TIMEOUT_SEC:-600}
      - JOB_CONNECT_TIMEOUT_SEC=${JOB_CONNECT_TIMEOUT_SEC:-30}

      # Security Settings
      - MAX_SSH_RETRIES=${MAX_SSH_RETRIES:-3}
      - MAX_SFTP_RETRIES=${MAX_SFTP_RETRIES:-3}

      # Retention
      - RETENTION_DAYS=${RETENTION_DAYS:-7}
      - CLEANUP_ENABLED=${CLEANUP_ENABLED:-true}

    # Volume mounts
    volumes:
      # Persistent storage for jobs, transcripts, and received files
      - ./storage:/app/storage

      # Optional: Mount custom profiles
      # - ./profiles.yaml:/app/profiles.yaml:ro

    # Resource limits (adjust based on your needs)
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 256M

    # Health check
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8000/health')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

    # Logging configuration
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

# Optional: Add a reverse proxy for HTTPS
# Uncomment and configure if needed
#
#   nginx:
#     image: nginx:alpine
#     container_name: cucm-collector-proxy
#     restart: unless-stopped
#     ports:
#       - "443:443"
#       - "80:80"
#     volumes:
#       - ./nginx.conf:/etc/nginx/nginx.conf:ro
#       - ./certs:/etc/nginx/certs:ro
#     depends_on:
#       - cucm-collector

# Named volumes (alternative to bind mounts)
# Uncomment if you prefer named volumes
#
# volumes:
#   storage:
#     driver: local
